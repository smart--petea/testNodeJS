var fs = require('fs'),
	path = require('path'),
	db = require('db'),
	qs = require('querystring'),
	_ = require('underscore'),
	sessions = require('sessions'),
	results;

/* file paths */
var authHtml = path.join(__dirname, "../html/auth.html");

/* exports */
module.exports.process = function(req, res) {
	switch(req.method){
		case "GET":
			/* give me auth.html file */
			throwAuthHtml(req, res); 
			break;
		case "POST":
			authorize(req, res);
			break;
		default:
			res.statusCode = 404;
			res.end("Can't recognize resource");
	}
}

/* functions */
function throwAuthHtml(req, res, errorMessage) {
		fs.readFile(authHtml, {'encoding': 'utf8'}, function(err, data) {
			if(err) throw err; 

			res.writeHead(200, {
				'Content-Type': "text/html",
			});
			var html = _.template(data, {
				error: errorMessage || "",
				submitVal: 'login',
			});
			res.end(html);
		});			
}

function authorize(req, res) {
	var data  = "";
	req.on('data', function(chunk) {
		data += chunk; 
	})

	req.on('end', function() {
		data = qs.parse(data);
		results = db.select('users', function(user){
			return user.name == data.login && user.passw == data.passw;
		});

		if(results.length === 0) {
			throwAuthHtml(req, res, "Login or password are wrong") 
		} else if(results.length > 1) {
			res.statusCode = 500;
			res.end("Server error");
		} else {

			/* if login and password are correct */
			/* 1. create session
				2. redirect to books page
			*/
			sessions.create(req);
			sessions.set(req, 'login', data.login);

			res.writeHeader(301, {
				Location: "/books",
				'Set-Cookie': "sessionId=" + req.sessionId,
			});	
			res.end("redirect");
		}
	});

	req.on('error', function() {
		res.statusCode(400);
		res.end("Bad Request");
	});
}
