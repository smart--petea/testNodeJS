var fs = require('fs'),
	path = require('path'),
	db = require('db'),
	qs = require('querystring'),
	_ = require('underscore'),
	sessions = require('sessions'),
	results;

/* file paths */
var authHtml = path.join(__dirname, "../html/auth.html");
var successHtml = path.join(__dirname, "../html/successRegister.html");

/* exports */
module.exports.process = function(req, res) {
	switch(req.method){
		case "GET":
			/* give me auth.html file */
			throwAuthHtml(req, res); 
			break;
		case "POST":
			register(req, res);
			break;
		default:
			res.statusCode = 404;
			res.end("Can't recognize resource");
	}
}

/* functions */
function throwAuthHtml(req, res, errorMessage) {
		fs.readFile(authHtml, {'encoding': 'utf8'}, function(err, data) {
			if(err) throw err; 

			res.writeHead(200, {
				'Content-Type': "text/html",
			});
			var html = _.template(data, {
				error: errorMessage || "",
				submitVal: 'register',
			});
			res.end(html);
		});			
}


function register(req, res) {
	var data  = "";
	req.on('data', function(chunk) {
		data += chunk; 
	})

	req.on('end', function() {
		data = qs.parse(data);
		for(var x in data) {
			/* trim and validate post data */
			data[x] = data[x].trim();
			if(data[x].length === 0) {
				throwAuthHtml(req, res, "Login or password are not setted") 
				return;
			}
		}

		results = db.select('users', function(user){
			return user.name == data.login && user.passw == data.passw;
		});

		if(results.length === 1) {
			throwAuthHtml(req, res, "This user just exist") 
		} else if(results.length > 1) {
			res.statusCode = 500;
			res.end("Server error");
		} else {

			/* if login and password are correct and do not exist in database
				we can try to insert it in db and redirect to auth.html*/

			db.insert('users', {
				name: data.login,
				passw: data.passw,
			});

			fs.readFile(successHtml, {encoding: 'utf8'}, function(err, content){
				if(err) throw err;

				res.statusCode = 200;
				res.end(content);

			}) ;
		}
	});

	req.on('error', function() {
		res.statusCode(400);
		res.end("Bad Request");
	});
}

