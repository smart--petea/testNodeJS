var fs = require('fs'),
	_ = require('underscore'),
	path = require('path');

var db = {}; // my database
var dbModules = { 
	'users': path.join(__dirname, "../db/users.dat"), //objects with fields 1. name, 2. passw
	'books': path.join(__dirname, "../db/books.dat"),
};


for(mdle in dbModules) db[mdle] = getJson(dbModules[mdle]); //init database

/* exports */
module.exports.select = select;
module.exports.insert = insert;
module.exports.del = del;
module.exports.update = update;

/* functions */
function getJson(filePath) {
	var result, 
		empty = [];  
	try {
		result = fs.readFileSync(filePath, {encoding: 'utf8'});
	} catch (e) {
		console.log(e);
		if(e.errno != 34) throw e; /* if error is other than file not exist */
		return empty;
	}

	try {
		result = JSON.parse(result);
	} catch (e) {
		return empty;
	}

	return result;
}

function select(tableName, predicate, context) {
	return _.filter(db[tableName], predicate, context);
}

function insert(tableName, objects) {
	!(objects instanceof Array) && (objects = [objects]); 
	console.log("objects: ", objects);

	for(var index in objects) {
		db[tableName].push(objects[index]);
	}
}

function update(tableName, predicate, forUpdate) {
	_.each(select(tableName, predicate), function(obj, ind) {
		//console.log('before: ', obj);
		//console.log('before: ', forUpdate);
		_.extend(obj, forUpdate);
		//console.log('after: ', obj);
		//console.log('after: ', forUpdate);
	});
}

function del(tableName, predicate, context) {
	db[tableName] = _.reject(db[tableName], predicate, context);
}

/* handlers */
process.on('exit', function(code) {
	var filename, filedata;
	for(mdle in dbModules) {
		filename = dbModules[mdle];
		filedata = JSON.stringify(db[mdle]);
		fs.writeFileSync(filename, filedata, {encoding: 'utf8'});	
	}
});
