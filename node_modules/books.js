var sessions = require('sessions'),
	fs = require('fs'),
	path = require('path'),
	_ = require('underscore'),
	url = require('url'),
	db = require('db'),
	qs = require('querystring'),
	colRegexp = /^\/books(\/\d+)?.*/i;


/* exports */
module.exports.process = function(req, res) {
	var matches = req.url.match(colRegexp);
	if(matches[1]) {
		//book info
		bookProcess(req, res, matches[1].slice(1));
	} else {
		//collection info
		bookCollProcess(req, res);
	}
}

/* functions */
function bookProcess(req, res, id) {
	switch(req.method) {
		case "GET":
			var book = db.select("books", function(book) {
				return book.id == id;
			})[0];

			res.writeHeader(200, {
				"Content-Type": "application/json",
			});
			res.end(JSON.stringify(book));
			break;
		case "DELETE":
			db.del("books", function(book) {
				return book.id == id;
			});

			res.statusCode = 200;
			res.end(id);
			break;
		case "PUT":
			var postData = "";
			req.on('data', function(chunk) {
				postData += chunk;
			});

			req.on('end', function() {
				postData = JSON.parse(postData);
				console.log(postData);
				db.update("books", function(book) {
					return book.id == id;
				}, postData);

				res.writeHeader(200, {
					"Content-Type": "application/json",
				});
				res.end(JSON.stringify(postData));
			});

			req.on('error', function() {
				res.statusCode = 400;
				res.end("bad request");
			});
			break;
		default:
			res.statusCode = 400;
			res.end("bad request");
	}
}

function bookCollProcess(req, res) {
}
